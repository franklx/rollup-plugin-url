{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import crypto from 'crypto';\nimport path from 'path';\nimport util from 'util';\nimport fs from 'fs';\n\nimport makeDir from 'make-dir';\nimport mime from 'mime';\nimport { createFilter } from '@rollup/pluginutils';\n\nconst fsStatPromise = util.promisify(fs.stat);\nconst fsReadFilePromise = util.promisify(fs.readFile);\nconst { posix, sep } = path;\nconst defaultInclude = ['**/*.svg', '**/*.png', '**/*.jpg', '**/*.gif'];\n\nexport default function url(options = {}) {\n  const {\n    limit = 14 * 1024,\n    include = defaultInclude,\n    exclude,\n    publicPath = '',\n    emitFiles = true,\n    fileName = '[hash][extname]'\n  } = options;\n  const filter = createFilter(include, exclude);\n\n  const copies = Object.create(null);\n\n  return {\n    name: 'url',\n    load(id) {\n      if (!filter(id)) {\n        return null;\n      }\n      return Promise.all([fsStatPromise(id), fsReadFilePromise(id)]).then(([stats, buffer]) => {\n        let data;\n        if ((limit && stats.size > limit) || limit === 0) {\n          const hash = crypto\n            .createHash('sha1')\n            .update(buffer)\n            .digest('hex')\n            .substr(0, 16);\n          const ext = path.extname(id);\n          const name = path.basename(id, ext);\n          // Determine the directory name of the file based\n          // on either the relative path provided in options,\n          // or the parent directory\n          const relativeDir = options.sourceDir\n            ? path.relative(options.sourceDir, path.dirname(id))\n            : path\n                .dirname(id)\n                .split(sep)\n                .pop();\n\n          // Generate the output file name based on some string\n          // replacement parameters\n          const outputFileName = fileName\n            .replace(/\\[hash\\]/g, hash)\n            .replace(/\\[extname\\]/g, ext)\n            // use `sep` for windows environments\n            .replace(/\\[dirname\\]/g, relativeDir === '' ? '' : `${relativeDir}${sep}`)\n            .replace(/\\[name\\]/g, name);\n          // Windows fix - exports must be in unix format\n          data = `${publicPath}${outputFileName.split(sep).join(posix.sep)}`;\n          copies[id] = outputFileName;\n        } else {\n          const mimetype = mime.getType(id);\n          const isSVG = mimetype === 'image/svg+xml';\n          data = isSVG ? encodeSVG(buffer) : buffer.toString('base64');\n          const encoding = isSVG ? '' : ';base64';\n          data = `data:${mimetype}${encoding},${data}`;\n        }\n        return `export default \"${data}\"`;\n      });\n    },\n    generateBundle: async function write(outputOptions) {\n      // Allow skipping saving files for server side builds.\n      if (!emitFiles) return;\n\n      await Promise.all(\n        Object.keys(copies).map(async (name) =>\n          this.emitFile({\n            type: \"asset\",\n            name: path.basename(name),\n            fileName: copies[name],\n            source: fs.readFileSync(name),\n          })\n        )\n      );\n    }\n  };\n}\n\n// https://github.com/filamentgroup/directory-encoder/blob/master/lib/svg-uri-encoder.js\nfunction encodeSVG(buffer) {\n  return (\n    encodeURIComponent(\n      buffer\n        .toString('utf-8')\n        // strip newlines and tabs\n        .replace(/[\\n\\r]/gim, '')\n        .replace(/\\t/gim, ' ')\n        // strip comments\n        .replace(/<!--(.*(?=-->))-->/gim, '')\n        // replace\n        .replace(/'/gim, '\\\\i')\n    )\n      // encode brackets\n      .replace(/\\(/g, '%28')\n      .replace(/\\)/g, '%29')\n  );\n}\n"],"names":["util","fs","path","createFilter","crypto","mime"],"mappings":"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"}